<%- breadcrum t("ranking.title") -%>

<div class='ranking-container'>
  <nav class='ranking-navbar' role='navigation'>
    <div class='filter-controls'>
      <%= form_for @ranking, url: ranking_path, method: :put, :html => { class: 'form-inline' } do |f| %>
        <div class='form-group form-group-flex'>
          <div class='label-block'>Per&iacute;odo del promedio:</div>
          <%= f.date_select :ref_since, {discard_day: true}, { class: 'form-control' } %>
          <span class='label-to'>a</span>
          <%= f.date_select :ref_until, {discard_day: true}, { class: 'form-control' } %>
        </div>
        <div class="btn-group">
          <%= f.select   :column_names,
                         Ranking::COLUMNS_FOR_VIEW.flatten.map{|name| t("monthly_stat.names.#{name}")},
                         {
                          multiple: :multiple,
                          data: {
                            'none-selected-text' => 'Seleccionar columnas'
                                }
                          },
                         {id: 'choose-columns-select'}
          %>
          
        </div>
        <!-- div class="btn-group"><button type="button" class="multiselect dropdown-toggle btn btn-info btn-sm" data-toggle="dropdown" title="None selected" aria-expanded="false"><span class="multiselect-selected-text">Seleccionar columnas</span> <b class="caret"></b></button><ul class="multiselect-container dropdown-menu"><li class="multiselect-item filter" value="0"><div class="input-group"><span class="input-group-addon"><i class="glyphicon glyphicon-search"></i></span><input class="form-control multiselect-search" type="text" placeholder="Search"><span class="input-group-btn"><button class="btn btn-info multiselect-clear-filter" type="button"><i class="glyphicon glyphicon-remove-circle"></i></button></span></div></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="full_name"> Nombre completo</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="first_name"> Nombre</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_name"> Apellido</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="gender"> género</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="level"> Grado</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="local_status"> Estado local</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="coefficient"> coeficiente</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="local_teacher"> Instructor</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="membership_ends_on"> Fin de membresía</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="membership_payment_type"> Forma de pago</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="membership_value"> Valor de membresía</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="membership_name"> Nombre de membresía</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="time_slots"> Horarios</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="followed_by_user"> En seguimiento por</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="email"> Email principal</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="telephone"> Telefono principal</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="identification"> identification</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="birthday"> Cumpleaños</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="age"> Edad</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="occupation"> Ocupación</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="observation"> observation</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="primary_address"> Dirección primaria</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="primary_postal_code"> Código postal de la dirección primaria</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="primary_neighborhood"> Barrio primario</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="primary_city"> Ciudad primaria</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="primary_state"> Estado primario</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="primary_country"> País primario</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="reason_ids"> Motivos última evasión</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_seen_at"> Vino por última vez el</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_revisacion"> last_revisacion</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_reunion"> last_reunion</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_dropout_date"> Fecha última evasión</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_gestion_date"> Fecha última gestión evolutiva</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_communicated_at"> Fecha última comunicación</label></a></li><li><a tabindex="0"><label class="checkbox"><input type="checkbox" value="last_enrollment_date"> Fecha última matricula</label></a></li></ul></div -->
        <div class='btn-group'>
          <button type='button' class='dropdown-toggle btn btn-secondary btn-sm'>Federaciones <span class='caret'></span></button>
        </div>
        <button type="submit" class="btn btn-secondary btn-sm">Aplicar</button>
      <% end -%>
    </div>
  </nav>
  <section class='ranking-content'>
    <div class='table-responsive'>
      <table id="ranking_table" class="table table-striped tablesorter-blue table-sorter">
        <thead class="static-table-header">
          <tr>
            <th> <%#= t('ranking.name') %> </th>
            <% @ranking.column_names.each do |name| %>
              <th> <%= t("monthly_stat.names.#{name}") %> </th>
            <% end %>
          </tr>
        </thead>
        <tbody>
          <% @ranking.matrix.each do |school, stats_hash| %>
            <tr>
              <th><%= link_to_if can?(:read, school), school.name, school %></th>
              <% @ranking.column_names.each do |name| %>
                <% if stats_hash[name.to_s].nil? -%>
                  <td></td>
                <% else -%>
                  <td>
                    <span data-toggle="tooltip" data-placement="top"
                      title="<%= t('ranking.sample_size', size: stats_hash[name.to_s].size) %>">
                      <%= print_value stats_hash[name.to_s] %>
                    </span>
                  </td>
                <% end -%>
              <% end %>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="panel panel-danger">
      <div class="panel-heading"><%= t('ranking.missing_schools') %></div>
      <div class="panel-body">
        <table class="table table-striped table-bordered table-condensed">
          <% @missing_schools.each_slice(3) do |schools_row| %>
            <tr>
              <% schools_row.each do |school| -%>
                <td><%= link_to_if can?(:read, school), school.name, school %></td>
              <% end -%>
          </tr>
          <% end %>
        </table>
      </div>
    </div>
  </section>
</div>

<div class="page-header" hidden>
  <%= link_to "<span class='glyphicon glyphicon-cloud-download'></span> #{t('download')}".html_safe, ranking_url(id: @ranking, format: 'csv'), class: 'btn btn-default', id: 'download-link' %>
  <h2><%= t('ranking.title') %></h2>

</div>

<div id="options-panel" class="panel panel-default" hidden>
  <div class="panel-heading" data-toggle="collapse" data-target="#options-panel .panel-body">
    <%= t('.options') %>
    <span class="glyphicon glyphicon-collapse-down pull-right"></span>
  </div>
  <div class="panel-body collapse">
    <%= form_for @ranking, url: ranking_path, method: :put, class: "form-horizontal" do |f| %>
      <h4><%= t('ranking.date') %></h4>
      <div class="form-group form-inline">
        <%= f.date_select :ref_since, {discard_day: true}, { class: 'form-control' } %>
        <%= f.date_select :ref_until, {discard_day: true}, { class: 'form-control' } %>
      </div> 

      <h4><%= t('ranking.federations') %></h4>
      <div class="btn-group form-group" data-toggle="buttons">
      <% @federations.each do |fed| -%>
        <label class="checkbox-inline col-sm-offset-1 btn btn-default btn-sm">
          <%= f.check_box 'federation_ids', {multiple: true, checked: federation_selected?(fed.id,@ranking)}, fed.id, false %> <%= fed.name %>
        </label>
      <% end -%>
      </div>

      <h4><%= t('ranking.columns')%></h4>
      <% Ranking::COLUMNS_FOR_VIEW.each do |row_of_names| -%>
        <div class="btn-group input-group" data-toggle="buttons">
          <% row_of_names.each do |name|-%>
            <label class="btn btn-default btn-sm">
              <%= f.check_box :column_names, {multiple: true, checked: column_name_selected?(name,@ranking)}, name, false %> <%= t("monthly_stat.names.#{name}") %>
            </label>
          <% end -%>
        </div>
      <% end -%>
        <div class="form-group">
          <button type="submit" class="btn btn-primary col-sm-offset-0"><%= t('submit') %></button>
        </div>
    <% end -%>
  </div>
</div>

<table id="ranking_table" class="table table-striped table-bordered table-condensed tablesorter-blue" hidden>
  <thead class="static-table-header">
    <tr>
      <th> <%= t('ranking.name') %> </th>
      <% @ranking.column_names.each do |name| %>
        <th> <%= t("monthly_stat.names.#{name}") %> </th>
      <% end %>
    </tr>
  </thead>
  <tbody>
    <% @ranking.matrix.each do |school, stats_hash| %>
      <tr>
        <th> <%= link_to_if can?(:read, school), school.name, school %> </th>
        <% @ranking.column_names.each do |name| %>
          <% if stats_hash[name.to_s].nil? -%>
            <td></td>
          <% else -%>
            <td>
              <span data-toggle="tooltip" data-placement="top"
                title="<%= t('ranking.sample_size', size: stats_hash[name.to_s].size) %>">
                <%= print_value stats_hash[name.to_s] %>
              </span>
            </td>
          <% end -%>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<div class="panel panel-danger" hidden>
  <div class="panel-heading"><%= t('ranking.missing_schools') %></div>
  <div class="panel-body">
    <table class="table table-striped table-bordered table-condensed">
      <% @missing_schools.each_slice(3) do |schools_row| %>
        <tr>
          <% schools_row.each do |school| -%>
            <td><%= link_to_if can?(:read, school), school.name, school %></td>
          <% end -%>
      </tr>
      <% end %>
    </table>
  </div>
</div>